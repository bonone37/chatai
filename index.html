<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Assistant</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/lib/highlight.min.js"></script>
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="logo" onclick="backToHome()" style="cursor: pointer;">AI Chat</div>
        </nav>

        <!-- é¦–é¡µå†…å®¹ -->
        <main class="hero" id="homepage">
            <h1>æ™ºèƒ½AIåŠ©æ‰‹</h1>
            <p class="subtitle">å³æ—¶å¯¹è¯ï¼Œæ™ºèƒ½è§£ç­”ï¼Œå¼€å¯AIå¯¹è¯æ–°ä½“éªŒ</p>
            <button class="start-chat-btn" onclick="showChat()">å¼€å§‹å¯¹è¯</button>
            
            <div class="features">
                <div class="feature-card">
                    <div class="icon">ğŸš€</div>
                    <h3>å³æ—¶å“åº”</h3>
                    <p>æ¯«ç§’çº§å›å¤</p>
                </div>
                <div class="feature-card">
                    <div class="icon">ğŸ”’</div>
                    <h3>å®‰å…¨å¯é </h3>
                    <p>éšç§ä¿æŠ¤</p>
                </div>
            </div>
        </main>

        <!-- èŠå¤©ç•Œé¢ -->
        <div class="chat-interface hidden" id="chatInterface">
            <div class="sidebar">
                <button class="new-chat-btn" onclick="startNewChat()">
                    <span class="plus-icon">+</span> æ–°å¯¹è¯
                </button>
                <div class="history-list">
                    <div class="history-title">å†å²å¯¹è¯</div>
                    <div id="chatHistoryList">
                        <!-- å†å²å¯¹è¯å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>
            </div>
            <div class="chat-main">
                <div class="chat-container">
                    <div class="message ai">
                        <div class="avatar">AI</div>
                        <div class="text">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å—ï¼Ÿ</div>
                    </div>
                </div>
                <div class="input-container">
                    <input type="text" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." id="messageInput">
                    <button class="send-btn" onclick="sendMessage()">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const DEEPSEEK_API_KEY = 'sk-e778ebc7ccc64bcf82bcb1e05b5e0eab';
        const API_URL = 'https://api.deepseek.com/v1/chat/completions';
        
        // å­˜å‚¨å¯¹è¯å†å²
        let conversationHistory = [];
        let allConversations = [];
        let currentConversationId = null;

        // é…ç½® marked
        marked.setOptions({
            highlight: function(code, language) {
                if (language && hljs.getLanguage(language)) {
                    return hljs.highlight(code, { language }).value;
                }
                return code;
            },
            breaks: true
        });

        function showChat() {
            document.getElementById('homepage').classList.add('hidden');
            document.getElementById('chatInterface').classList.remove('hidden');
            if (!currentConversationId) {
                startNewChat();
            }
        }

        function startNewChat() {
            // ä¿å­˜å½“å‰å¯¹è¯
            if (conversationHistory.length > 0) {
                saveCurrentChat();
            }

            // æ¸…ç©ºå½“å‰å¯¹è¯
            conversationHistory = [];
            currentConversationId = Date.now();
            
            // æ¸…ç©ºèŠå¤©ç•Œé¢
            const chatContainer = document.querySelector('.chat-container');
            chatContainer.innerHTML = `
                <div class="message ai">
                    <div class="avatar">AI</div>
                    <div class="text">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å—ï¼Ÿ</div>
                </div>
            `;

            // æ›´æ–°å†å²åˆ—è¡¨é€‰ä¸­çŠ¶æ€
            updateHistoryList();
        }

        function saveCurrentChat() {
            if (conversationHistory.length > 0) {
                // ä½¿ç”¨ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºå¯¹è¯æ ‡é¢˜
                const firstUserMessage = conversationHistory.find(msg => msg.role === 'user');
                const title = firstUserMessage 
                    ? firstUserMessage.content.substring(0, 20) + "..."
                    : "æ–°å¯¹è¯";
                    
                const chat = {
                    id: currentConversationId,
                    title: title,
                    messages: [...conversationHistory],
                    timestamp: new Date().toLocaleString()
                };
                
                // æ›´æ–°æˆ–æ·»åŠ åˆ°å†å²è®°å½•
                const existingIndex = allConversations.findIndex(c => c.id === chat.id);
                if (existingIndex >= 0) {
                    allConversations[existingIndex] = chat;
                } else {
                    allConversations.unshift(chat);
                }
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('chatHistory', JSON.stringify(allConversations));
                updateHistoryList();
            }
        }

        function loadChat(chat) {
            // ä¿å­˜å½“å‰å¯¹è¯
            if (conversationHistory.length > 0) {
                saveCurrentChat();
            }
            
            // åŠ è½½é€‰ä¸­çš„å¯¹è¯
            currentConversationId = chat.id;
            conversationHistory = [...chat.messages];
            
            // æ›´æ–°èŠå¤©ç•Œé¢
            const chatContainer = document.querySelector('.chat-container');
            chatContainer.innerHTML = '';
            
            conversationHistory.forEach(msg => {
                const messageHtml = `
                    <div class="message ${msg.role === 'user' ? 'user' : 'ai'}">
                        <div class="avatar">${msg.role === 'user' ? 'æˆ‘' : 'AI'}</div>
                        <div class="text">${msg.role === 'assistant' ? marked.parse(msg.content) : msg.content}</div>
                    </div>
                `;
                chatContainer.insertAdjacentHTML('beforeend', messageHtml);
            });
        }

        function updateHistoryList() {
            const historyList = document.getElementById('chatHistoryList');
            historyList.innerHTML = '';
            
            allConversations.forEach(chat => {
                const chatElement = document.createElement('div');
                chatElement.className = 'chat-history-item';
                if (chat.id === currentConversationId) {
                    chatElement.classList.add('active');
                }
                
                chatElement.innerHTML = `
                    <span class="icon">ğŸ’­</span>
                    <div class="chat-info">
                        <div class="title">${chat.title}</div>
                        <div class="timestamp">${chat.timestamp}</div>
                    </div>
                    <button class="delete-chat" onclick="deleteChat(event, ${chat.id})">ğŸ—‘ï¸</button>
                `;
                
                chatElement.onclick = (e) => {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®ï¼Œä¸è¦è§¦å‘åŠ è½½å¯¹è¯
                    if (!e.target.classList.contains('delete-chat')) {
                        loadChat(chat);
                    }
                };
                historyList.appendChild(chatElement);
            });
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;

            // ç¦ç”¨è¾“å…¥
            setInputState(true);

            const chatContainer = document.querySelector('.chat-container');
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
            const userMessage = `
                <div class="message user">
                    <div class="text">${message}</div>
                    <div class="avatar">æˆ‘</div>
                </div>
            `;
            chatContainer.insertAdjacentHTML('beforeend', userMessage);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²è®°å½•
            conversationHistory.push({
                role: "user",
                content: message
            });

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loadingMessage = `
                <div class="message ai" id="loading-message">
                    <div class="avatar">AI</div>
                    <div class="text">æ­£åœ¨æ€è€ƒ...</div>
                </div>
            `;
            chatContainer.insertAdjacentHTML('beforeend', loadingMessage);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: conversationHistory,
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });

                if (!response.ok) {
                    throw new Error('API è¯·æ±‚å¤±è´¥');
                }

                const data = await response.json();
                const aiResponse = data.choices[0].message.content;

                // ç§»é™¤åŠ è½½æ¶ˆæ¯
                document.getElementById('loading-message').remove();

                // æ·»åŠ  AI å›å¤åˆ°ç•Œé¢ï¼ˆä½¿ç”¨ marked æ¸²æŸ“ markdownï¼‰
                const aiMessage = `
                    <div class="message ai">
                        <div class="avatar">AI</div>
                        <div class="text">${marked.parse(aiResponse)}</div>
                    </div>
                `;
                chatContainer.insertAdjacentHTML('beforeend', aiMessage);

                // æ·»åŠ  AI å›å¤åˆ°å†å²è®°å½•
                conversationHistory.push({
                    role: "assistant",
                    content: aiResponse
                });

                // ä¿å­˜å¯¹è¯
                saveCurrentChat();

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading-message').remove();
                
                const errorMessage = `
                    <div class="message ai error">
                        <div class="avatar">AI</div>
                        <div class="text">æŠ±æ­‰ï¼Œå‘ç”Ÿäº†ä¸€äº›é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚</div>
                    </div>
                `;
                chatContainer.insertAdjacentHTML('beforeend', errorMessage);
            }

            // å¯ç”¨è¾“å…¥
            setInputState(false);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // æ”¯æŒæŒ‰å›è½¦å‘é€æ¶ˆæ¯
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function setInputState(disabled) {
            const input = document.getElementById('messageInput');
            const sendButton = document.querySelector('.send-btn');
            input.disabled = disabled;
            sendButton.disabled = disabled;
        }

        // åœ¨é¡µé¢åŠ è½½æ—¶ä»æœ¬åœ°å­˜å‚¨åŠ è½½å†å²è®°å½•
        document.addEventListener('DOMContentLoaded', () => {
            const savedHistory = localStorage.getItem('chatHistory');
            if (savedHistory) {
                allConversations = JSON.parse(savedHistory);
                updateHistoryList();
            }
        });

        // æ·»åŠ è¿”å›ä¸»é¡µå‡½æ•°
        function backToHome() {
            document.getElementById('chatInterface').classList.add('hidden');
            document.getElementById('homepage').classList.remove('hidden');
        }

        // æ·»åŠ åˆ é™¤å¯¹è¯çš„å‡½æ•°
        function deleteChat(event, chatId) {
            event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿ')) {
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¯¹è¯ï¼Œæ¸…ç©ºå½“å‰å¯¹è¯
                if (chatId === currentConversationId) {
                    conversationHistory = [];
                    currentConversationId = null;
                    const chatContainer = document.querySelector('.chat-container');
                    chatContainer.innerHTML = `
                        <div class="message ai">
                            <div class="avatar">AI</div>
                            <div class="text">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å—ï¼Ÿ</div>
                        </div>
                    `;
                }
                
                // ä»å†å²è®°å½•ä¸­åˆ é™¤
                allConversations = allConversations.filter(chat => chat.id !== chatId);
                
                // æ›´æ–°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('chatHistory', JSON.stringify(allConversations));
                
                // æ›´æ–°ç•Œé¢
                updateHistoryList();
            }
        }
    </script>
</body>
</html> 